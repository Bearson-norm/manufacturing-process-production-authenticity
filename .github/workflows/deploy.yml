name: Deploy to Production

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (DANGEROUS - only use if CI passed)'
        required: false
        default: 'false'

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install and test
      run: |
        npm install
        cd client && npm install && npm run build && cd ..
        cd server && npm install && node -c index.js && cd ..
    continue-on-error: false

  deploy:
    needs: ci
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: Install dependencies
      run: |
        npm install
        cd client && npm install && cd ..
        cd server && npm install && cd ..
        
    - name: Build client
      run: |
        cd client
        npm run build
        
    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r server deploy/
        cp -r client/build deploy/client-build
        cp package.json deploy/
        cp -r .github/scripts deploy/scripts || true
        # Ensure ecosystem.config.js is included
        if [ -f server/ecosystem.config.js ]; then
          cp server/ecosystem.config.js deploy/server/
        fi
        # Copy nginx config for production
        mkdir -p deploy/nginx
        if [ -f nginx/manufacturing-app.conf ]; then
          cp nginx/manufacturing-app.conf deploy/nginx/
        fi
        tar -czf deploy.tar.gz deploy/
        
    - name: Deploy to VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deploy.tar.gz"
        target: "/home/${{ secrets.VPS_USER }}/deployments"
        
    - name: Execute deployment script on VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          cd /home/${{ secrets.VPS_USER }}/deployments
          tar -xzf deploy.tar.gz
          
          # Backup existing deployment
          if [ -d "manufacturing-app" ]; then
            mv manufacturing-app manufacturing-app-backup-$(date +%Y%m%d-%H%M%S)
          fi
          
          # Create new deployment directory
          mkdir -p manufacturing-app
          mv deploy/* manufacturing-app/
          
          # Install/update dependencies
          cd manufacturing-app/server
          npm install --production
          
          # Create production .env if it doesn't exist
          if [ ! -f .env ]; then
            echo "üìù Creating production .env file..."
            echo "NODE_ENV=production" > .env
            echo "PORT=1234" >> .env
            echo "DB_HOST=localhost" >> .env
            echo "DB_PORT=5433" >> .env
            echo "DB_NAME=manufacturing_db" >> .env
            echo "DB_USER=admin" >> .env
            echo "DB_PASSWORD=Admin123" >> .env
          else
            # Ensure PORT is set to production port
            if grep -q "^PORT=" .env; then
              sed -i "s/^PORT=.*/PORT=1234/" .env
            else
              echo "PORT=1234" >> .env
            fi
            # Ensure NODE_ENV is production
            if grep -q "^NODE_ENV=" .env; then
              sed -i "s/^NODE_ENV=.*/NODE_ENV=production/" .env
            else
              echo "NODE_ENV=production" >> .env
            fi
            # Ensure DB_USER is admin
            if grep -q "^DB_USER=" .env; then
              sed -i "s/^DB_USER=.*/DB_USER=admin/" .env
            else
              echo "DB_USER=admin" >> .env
            fi
            # Ensure DB_PASSWORD is set
            if ! grep -q "^DB_PASSWORD=" .env; then
              echo "DB_PASSWORD=Admin123" >> .env
            fi
            # Ensure DB_PORT is 5433
            if grep -q "^DB_PORT=" .env; then
              sed -i "s/^DB_PORT=.*/DB_PORT=5433/" .env
            else
              echo "DB_PORT=5433" >> .env
            fi
          fi
          
          # Verify .env file
          echo "üìù Verifying production .env file..."
          cat .env
          
          # Restart application with PM2 using ecosystem config
          cd /home/${{ secrets.VPS_USER }}/deployments/manufacturing-app/server
          mkdir -p logs
          pm2 delete manufacturing-app || true
          
          # Start with ecosystem config if available, otherwise use direct start
          if [ -f ecosystem.config.js ]; then
            pm2 start ecosystem.config.js
          else
            pm2 start index.js --name manufacturing-app --instances max --exec-mode cluster --cwd /home/${{ secrets.VPS_USER }}/deployments/manufacturing-app/server --env production
          fi
          pm2 save
          
          # Cleanup old backups (keep last 5)
          cd /home/${{ secrets.VPS_USER }}/deployments
          ls -dt manufacturing-app-backup-* | tail -n +6 | xargs rm -rf || true
          
          # Wait a bit for app to start
          sleep 5
          
          # Health check - REQUIRED for production
          echo "üè• Performing PRODUCTION health check..."
          PROD_PORT=1234
          MAX_RETRIES=5
          RETRY_COUNT=0
          HEALTH_CHECK_PASSED=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HEALTH_CHECK=$(curl -s http://localhost:$PROD_PORT/health || echo "failed")
            if echo "$HEALTH_CHECK" | grep -q "healthy"; then
              echo "‚úÖ PRODUCTION health check PASSED!"
              HEALTH_CHECK_PASSED=true
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              echo "‚è≥ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying in 3 seconds..."
              echo "   Response: $HEALTH_CHECK"
              sleep 3
            fi
          done
          
          if [ "$HEALTH_CHECK_PASSED" = false ]; then
            echo "‚ùå CRITICAL: PRODUCTION health check FAILED after $MAX_RETRIES attempts!"
            echo "üîÑ Attempting rollback to previous version..."
            
            # Find latest backup
            LATEST_BACKUP=$(ls -dt /home/${{ secrets.VPS_USER }}/deployments/manufacturing-app-backup-* 2>/dev/null | head -1)
            if [ -n "$LATEST_BACKUP" ]; then
              echo "üì¶ Rolling back to: $LATEST_BACKUP"
              rm -rf manufacturing-app
              cp -r "$LATEST_BACKUP" manufacturing-app
              cd manufacturing-app/server
              pm2 restart manufacturing-app
              pm2 save
              echo "‚úÖ Rollback completed. Please check the application manually."
            else
              echo "‚ö†Ô∏è  No backup found for rollback. Manual intervention required!"
            fi
            
            exit 1
          fi
          
          # Cleanup
          rm -f deploy.tar.gz
          
          echo "‚úÖ PRODUCTION deployment completed successfully!"
          echo "üìç Production app verified and running on port: $PROD_PORT"
          
          # Trigger MO sync to update cache with new filters
          echo "üîÑ Triggering MO sync to update cache with new filters..."
          sleep 10  # Wait a bit more for app to be fully ready
          SYNC_RESPONSE=$(curl -s -X POST http://localhost:$PROD_PORT/api/admin/sync-mo || echo "failed")
          if echo "$SYNC_RESPONSE" | grep -q "success\|started"; then
            echo "‚úÖ MO sync triggered successfully"
            echo "   Response: $SYNC_RESPONSE"
            echo "‚è≥ Sync is running in background. MO data will be updated within 60-90 seconds."
          else
            echo "‚ö†Ô∏è  MO sync trigger may have failed (this is non-critical)"
            echo "   Response: $SYNC_RESPONSE"
            echo "   You can manually trigger sync later: curl -X POST http://localhost:$PROD_PORT/api/admin/sync-mo"
          fi

