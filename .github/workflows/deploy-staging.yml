name: Deploy to Staging

on:
  push:
    branches:
      - staging
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests (not recommended)'
        required: false
        default: 'false'

jobs:
  ci:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install and test
      run: |
        npm install
        cd client && npm install && npm run build && cd ..
        cd server && npm install && node -c index.js && cd ..
    continue-on-error: false

  deploy-staging:
    needs: ci
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/staging' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: package-lock.json
        
    - name: Install dependencies
      run: |
        npm install
        cd client && npm install && cd ..
        cd server && npm install && cd ..
        
    - name: Build client
      run: |
        cd client
        npm run build
        
    - name: Create deployment package
      run: |
        mkdir -p deploy
        cp -r server deploy/
        cp -r client/build deploy/client-build
        cp package.json deploy/
        cp -r .github/scripts deploy/scripts || true
        # Ensure ecosystem.config.js is included
        if [ -f server/ecosystem.config.js ]; then
          cp server/ecosystem.config.js deploy/server/
        fi
        # Create staging-specific env file if needed
        tar -czf deploy.tar.gz deploy/
        
    - name: Deploy to Staging VPS
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        source: "deploy.tar.gz"
        target: "/home/${{ secrets.VPS_USER }}/deployments"
        
    - name: Execute staging deployment script on VPS
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USER }}
        key: ${{ secrets.VPS_SSH_KEY }}
        port: ${{ secrets.VPS_PORT || 22 }}
        script: |
          set -e
          
          STAGING_DIR="/home/${{ secrets.VPS_USER }}/deployments/manufacturing-app-staging"
          STAGING_PORT=5678
          
          echo "ğŸš€ Starting STAGING deployment..."
          echo "ğŸ“ Staging directory: $STAGING_DIR"
          echo "ğŸ“ Staging port: $STAGING_PORT"
          
          cd /home/${{ secrets.VPS_USER }}/deployments
          tar -xzf deploy.tar.gz
          
          # Verify extracted files
          echo "ğŸ“‹ Checking extracted files..."
          ls -la deploy/ || echo "âš ï¸  Deploy directory check"
          ls -la deploy/server/ || echo "âš ï¸  Server directory check"
          
          # Backup existing staging deployment
          if [ -d "$STAGING_DIR" ]; then
            echo "ğŸ“¦ Creating staging backup..."
            mv "$STAGING_DIR" "${STAGING_DIR}-backup-$(date +%Y%m%d-%H%M%S)"
          fi
          
          # Create new staging deployment directory
          echo "ğŸ“ Creating staging directory..."
          mkdir -p "$STAGING_DIR"
          mv deploy/* "$STAGING_DIR/"
          
          # Verify files moved correctly
          echo "ğŸ“‹ Verifying deployment files..."
          if [ ! -d "$STAGING_DIR/server" ]; then
            echo "âŒ ERROR: Server directory not found in $STAGING_DIR"
            ls -la "$STAGING_DIR/"
            exit 1
          fi
          
          if [ ! -f "$STAGING_DIR/server/index.js" ]; then
            echo "âŒ ERROR: index.js not found in $STAGING_DIR/server"
            ls -la "$STAGING_DIR/server/"
            exit 1
          fi
          
          # Install/update dependencies
          echo "ğŸ“¦ Installing staging dependencies..."
          cd "$STAGING_DIR/server"
          npm install --production
          
          # Create staging .env if it doesn't exist
          if [ ! -f .env ]; then
            echo "ğŸ“ Creating staging .env file..."
            echo "NODE_ENV=staging" > .env
            echo "PORT=5678" >> .env
            echo "DB_HOST=localhost" >> .env
            echo "DB_PORT=5433" >> .env
            echo "DB_NAME=manufacturing_db_staging" >> .env
            echo "DB_USER=manufacturing_user" >> .env
          else
            # Ensure PORT is set to staging port
            if grep -q "^PORT=" .env; then
              sed -i "s/^PORT=.*/PORT=$STAGING_PORT/" .env
            else
              echo "PORT=$STAGING_PORT" >> .env
            fi
            # Ensure NODE_ENV is staging
            if grep -q "^NODE_ENV=" .env; then
              sed -i "s/^NODE_ENV=.*/NODE_ENV=staging/" .env
            else
              echo "NODE_ENV=staging" >> .env
            fi
          fi
          
          # Verify .env file
          echo "ğŸ“ Verifying .env file..."
          cat .env
          
          # Create logs directory
          mkdir -p logs
          
          # Restart staging application with PM2
          echo "ğŸ”„ Restarting staging application with PM2..."
          cd "$STAGING_DIR/server"
          
          # Delete existing process if exists
          pm2 delete manufacturing-app-staging 2>/dev/null || echo "No existing staging process to delete"
          
          # Verify current directory and files
          echo "ğŸ“‹ Current directory: $(pwd)"
          echo "ğŸ“‹ Files in server directory:"
          ls -la
          
          # Start application with PM2
          echo "ğŸš€ Starting application..."
          if [ -f ecosystem.config.js ]; then
            echo "ğŸ“‹ Using ecosystem.config.js"
            pm2 start ecosystem.config.js --name manufacturing-app-staging --update-env
          else
            echo "ğŸ“‹ Using direct start with index.js"
            pm2 start index.js --name manufacturing-app-staging --instances 1 --cwd "$STAGING_DIR/server"
          fi
          
          # Verify PM2 process started
          echo "â³ Waiting 2 seconds for PM2 to register process..."
          sleep 2
          
          echo "ğŸ“Š PM2 Status:"
          pm2 status
          
          # Check if process is running
          if pm2 list | grep -q "manufacturing-app-staging"; then
            echo "âœ… PM2 process 'manufacturing-app-staging' is registered"
          else
            echo "âŒ ERROR: PM2 process 'manufacturing-app-staging' NOT found!"
            echo "ğŸ“‹ PM2 list output:"
            pm2 list
            echo "ğŸ“‹ PM2 logs:"
            pm2 logs manufacturing-app-staging --lines 20 --nostream || true
            exit 1
          fi
          
          pm2 save
          echo "âœ… PM2 process saved"
          
          # Wait a bit for app to start
          sleep 5
          
          # Health check
          echo "ğŸ¥ Checking staging health..."
          HEALTH_CHECK=$(curl -s http://localhost:$STAGING_PORT/health || echo "failed")
          if echo "$HEALTH_CHECK" | grep -q "healthy"; then
            echo "âœ… Staging health check passed!"
          else
            echo "âš ï¸  Staging health check failed, but continuing..."
            echo "Response: $HEALTH_CHECK"
          fi
          
          # Setup nginx config for staging (if not exists)
          if [ ! -f /etc/nginx/sites-available/manufacturing-app-staging.conf ]; then
            echo "ğŸ“ Please setup nginx config for staging manually"
            echo "   See: nginx/manufacturing-app-staging.conf"
          fi
          
          # Cleanup old staging backups (keep last 3)
          echo "ğŸ§¹ Cleaning up old staging backups..."
          cd /home/${{ secrets.VPS_USER }}/deployments
          ls -dt manufacturing-app-staging-backup-* 2>/dev/null | tail -n +4 | xargs rm -rf || true
          
          # Cleanup
          rm -f deploy.tar.gz
          
          echo "âœ… Staging deployment completed!"
          echo "ğŸ“ Staging app running on port: $STAGING_PORT"
          pm2 status | grep manufacturing-app-staging || echo "âš ï¸  Check PM2 status manually"
